# MouseTrace API

This document describes the HTTP endpoints exposed by the MouseTrace Insights server, the expected inputs, and the exact response shapes.

Base URL: `http://127.0.0.1:8000`

## Authentication

Only OpenAI‑backed endpoints require an API key: `/insights` and `/daily-summary`.

- Preferred: set `OPENAI_API_KEY` in the server environment (e.g., `.env`).
- Overrides:
  - Header: `X-OpenAI-Key: <key>` (both endpoints)
  - Body (for `/insights` only): `api_key` overrides header/env

All other endpoints are unauthenticated.

## Data Types

- Timestamps: Unix epoch seconds as floating‑point numbers.
- Verdict enums:
  - Productivity assessments: `good | neutral | bad`
  - Screenshot classifier: `productive | neutral | distracting`

## Endpoints

### GET `/health`

- Purpose: Liveness probe
- Response:
  ```json
  { "status": "ok" }
  ```

### GET `/schema`

- Purpose: Return the database schema SQL text
- Response:
  ```json
  { "schema": "<full DDL text>" }
  ```

### GET `/summary`

- Purpose: High‑level activity summary (lifetime/overall)
- Response fields:
  - `clicks` (int)
  - `moves` (int)
  - `switches` (int)
  - `keypresses` (int)
  - `kpm_overall` (float)
  - `kpm_last_60m` (float)
  - `best_kpm` (float)
  - `best_kpm_window` (object|null): `{ start_ts, end_ts, keypresses }`
  - `top_apps` (array): `[ [app_name, clicks], ... ]`

### POST `/insights`

- Purpose: Agentic Q&A over the telemetry DB using tools
- Auth: Requires OpenAI key (env/header/body)
- Request body:
  ```json
  {
    "question": "string",
    "model": "string (optional)",
    "api_key": "string (optional)"
  }
  ```
- Response:
  ```json
  {
    "answer": "string",
    "used_tools": [ { "name": "tool", "args": {"...": "..."} } ]
  }
  ```

### GET `/assessments?limit=50`

- Purpose: Latest productivity verdicts generated by the notifier
- Query params: `limit` (default 50, max 500)
- Response: Array of objects
  ```json
  [
    {
      "id": 1,
      "start_ts": 1715600000.0,
      "end_ts": 1715600120.0,
      "verdict": "good",
      "score": 0.86,
      "reason": "short agent explanation",
      "created_at": 1715600121.2
    }
  ]
  ```

### GET `/screenshots?limit=50`

- Purpose: Latest screenshots with summaries
- Query params: `limit` (default 50, max 200)
- Response: Array of objects
  ```json
  [
    {
      "id": 42,
      "ts": 1715601000.1,
      "path": "/Users/.../Pictures/mousetrace/20240513_120500.png",
      "summary": "coding session in VS Code",
      "verdict": "productive",
      "created_at": 1715601001.0
    }
  ]
  ```

### GET `/screenshots/{id}`

- Purpose: Full screenshot record (includes raw OCR text)
- Response:
  ```json
  {
    "id": 42,
    "ts": 1715601000.1,
    "path": "/Users/.../Pictures/mousetrace/20240513_120500.png",
    "ocr_text": "...",
    "summary": "coding session in VS Code",
    "verdict": "productive",
    "created_at": 1715601001.0
  }
  ```

### GET `/daily-summary?hours=24`

- Purpose: Human, friendly daily report combining activity + screenshots + assessments + sleep + physical activity
- Auth: Requires OpenAI key (env or `X-OpenAI-Key` header)
- Query params:
  - `hours` (int, default 24, range 1–72)
  - `model` (string, optional)
- Response:
  ```json
  {
    "answer": "2–3 sentence overview + 4–6 concise bullets + two lifestyle predictions (work/off‑work) + final 'score=0.xx'",
    "used_tools": [ { "name": "tool", "args": {"...": "..."} } ]
  }
  ```

## Operational Notes

Initialize and run producers so the API has data:

```bash
python -m mousetrace init-db --db mouse_trace.sqlite3
python -m mousetrace run --db mouse_trace.sqlite3
python -m mousetrace notify --db mouse_trace.sqlite3 --interval 120
python -m mousetrace sight --db mouse_trace.sqlite3 --interval 300 --out-dir ~/Pictures/mousetrace
```

macOS permissions required:

- Accessibility (for input capture)
- Screen Recording (for screenshots)

